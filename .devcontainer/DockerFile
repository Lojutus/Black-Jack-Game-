# Use Ubuntu 22.04 base
FROM ubuntu:22.04

ARG USER=dev
ARG UID=1000
ENV DEBIAN_FRONTEND=noninteractive

# Prepara el sistema e instala herramientas necesarias (incluye cmake para compilar gtest)
RUN apt-get update \
 && apt-get install -y --no-install-recommends \
  build-essential \
    cmake \
    git \
  curl \
    gdb \
    gdbserver \
    ninja-build \
    clang \
    lldb \
    valgrind \
    make \
    sudo \
    ca-certificates \
    openssh-client \
    procps \
    libcurl4-openssl-dev \
    nlohmann-json3-dev \
    libgtest-dev \
    libcurl4-openssl-dev \
    nlohmann-json3-dev \
&& rm -rf /var/lib/apt/lists/*

# Compila e instala GoogleTest (libgtest-dev provee c칩digo fuente en /usr/src/gtest)
RUN if [ -d /usr/src/googletest ] ; then \
      cd /usr/src/googletest && cmake . && make && cp -a lib/*.a /usr/lib/ || true ; \
    elif [ -d /usr/src/gtest ] ; then \
      cd /usr/src/gtest && cmake . && make && cp -a lib/*.a /usr/lib/ || true ; \
    fi

# Instala la cabecera single-file cpp-httplib (httplib.h) para poder usar #include <httplib.h>
RUN mkdir -p /usr/local/include && \
    curl -fsSL https://raw.githubusercontent.com/yhirose/cpp-httplib/master/httplib.h -o /usr/local/include/httplib.h && \
    chmod 644 /usr/local/include/httplib.h || \
    (echo "Advertencia: no se pudo descargar httplib.h durante la construcci칩n" )

# Crear usuario no-root con UID (usado por devcontainer.json)
RUN useradd -m -u ${UID} ${USER} \
 && echo "${USER} ALL=(ALL) NOPASSWD:ALL" > /etc/sudoers.d/${USER} \
 && chmod 0440 /etc/sudoers.d/${USER}

# Directorio de trabajo como el workspace esperado por devcontainer.json
WORKDIR /workspace

# Cambiar a usuario no-root
USER ${USER}

EXPOSE 2345

# Mantener el contenedor en ejecuci칩n (VS Code lo usar치)
ENTRYPOINT ["tail", "-f", "/dev/null"]
#manejo de curls

